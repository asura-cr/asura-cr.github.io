<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Asura Premium</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet"/>
  <style>
    .form {
      display: flex;
      flex-direction: column;
      gap: 10px;
      padding-left: 2em;
      padding-right: 2em;
      padding-bottom: 0.4em;
      background-color: #171717;
      border-radius: 25px;
      transition: .4s ease-in-out;
      max-width: 350px;
      margin: 0 auto;
    }
    
    .form:hover {
      transform: scale(1.05);
      border: 1px solid black;
    }
    
    #heading {
      text-align: center;
      margin: 2em;
      color: rgb(255, 255, 255);
      font-size: 1.2em;
    }
    
    .field {
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 0.5em;
      border-radius: 25px;
      padding: 0.6em;
      border: none;
      outline: none;
      color: white;
      background-color: #171717;
      box-shadow: inset 2px 5px 10px rgb(5, 5, 5);
    }
    
    .input-icon {
      height: 1.3em;
      width: 1.3em;
      fill: white;
    }
    
    .input-field {
      background: none;
      border: none;
      outline: none;
      width: 100%;
      color: #d3d3d3;
    }
    
    .button3 {
      margin-bottom: 3em;
      padding: 0.5em;
      border-radius: 5px;
      border: none;
      outline: none;
      transition: .4s ease-in-out;
      background-color: #252525;
      color: white;
    }
    
    .button3:hover {
      background-color: red;
      color: white;
    }

    .manga-card {
      transition: transform 0.3s ease, box-shadow 0.3s ease;
    }
    
    .manga-card:hover {
      transform: translateY(-5px);
      box-shadow: 0 10px 20px rgba(0, 0, 0, 0.3);
    }

    .chapter-link {
      transition: background-color 0.2s ease;
    }
    
    .chapter-link:hover {
      background-color: rgba(255,0,0,0.1);
    }

    /* Custom scrollbar */
    ::-webkit-scrollbar {
      width: 8px;
    }
    
    ::-webkit-scrollbar-track {
      background: #0f0f0f;
    }
    
    ::-webkit-scrollbar-thumb {
      background: #3f3f3f;
      border-radius: 4px;
    }
    
    ::-webkit-scrollbar-thumb:hover {
      background: #ff0000;
    }

    /* Animation classes */
    .fade-in {
      animation: fadeIn 0.5s ease forwards;
    }
    
    @keyframes fadeIn {
      from { opacity: 0; transform: translateY(10px); }
      to { opacity: 1; transform: translateY(0); }
    }
  </style>
</head>
<body class="bg-gray-900 text-white min-h-screen">
  <!-- Login Screen -->
  <div id="login-screen" class="fixed top-0 left-0 w-full h-full bg-gray-900 flex justify-center items-center z-50">
    <form class="form">
      <p id="heading">Asura Premium Login</p>
      <div class="field">
        <svg class="input-icon" xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" viewBox="0 0 16 16">
          <path d="M13.106 7.222c0-2.967-2.249-5.032-5.482-5.032-3.35 0-5.646 2.318-5.646 5.702 0 3.493 2.235 5.708 5.762 5.708.862 0 1.689-.123 2.304-.335v-.862c-.43.199-1.354.328-2.29.328-2.926 0-4.813-1.88-4.813-4.798 0-2.844 1.921-4.881 4.594-4.881 2.735 0 4.608 1.688 4.608 4.156 0 1.682-.554 2.769-1.416 2.769-.492 0-.772-.28-.772-.76V5.206H8.923v.834h-.11c-.266-.595-.881-.964-1.6-.964-1.4 0-2.378 1.162-2.378 2.823 0 1.737.957 2.906 2.379 2.906.8 0 1.415-.39 1.709-1.087h.11c.081.67.703 1.148 1.503 1.148 1.572 0 2.57-1.415 2.57-3.643zm-7.177.704c0-1.197.54-1.907 1.456-1.907.93 0 1.524.738 1.524 1.907S8.308 9.84 7.371 9.84c-.895 0-1.442-.725-1.442-1.914z"></path>
        </svg>
        <input autocomplete="off" placeholder="Discord Username" id="username" class="input-field" type="text">
      </div>
      <div class="field">
        <svg class="input-icon" xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" viewBox="0 0 16 16">
          <path d="M8 1a2 2 0 0 1 2 2v4H6V3a2 2 0 0 1 2-2zm3 6V3a3 3 0 0 0-6 0v4a2 2 0 0 0-2 2v5a2 2 0 0 0 2 2h6a2 2 0 0 0 2-2V9a2 2 0 0 0-2-2z"></path>
        </svg>
        <input placeholder="Password from Discord Bot" id="password" class="input-field" type="password">
      </div>
      <button type="button" id="login-button" class="button3">Login</button>
      <p class="text-center text-gray-400 text-sm mb-4">Get credentials from our Discord bot</p>
    </form>
  </div>

  <!-- Main Content -->
  <div id="content" class="hidden">
    <!-- Header with User Info -->
    <div class="bg-black shadow-lg">
      <div class="container mx-auto px-4 py-3 flex items-center justify-between">
        <div class="flex items-center space-x-3">
          <div class="bg-red-600 text-white px-2 py-1 rounded">
            PREMIUM
          </div>
          <h1 class="text-xl font-bold">Asura Loader</h1>
        </div>
        <div class="flex items-center space-x-4">
          <div id="session-info" class="text-sm text-gray-400 hidden md:block"></div>
          <button id="logout-button" class="bg-red-600 hover:bg-red-700 text-white px-3 py-1 rounded text-sm">
            Logout
          </button>
        </div>
      </div>
    </div>

    <!-- Main Content Area -->
    <div class="container mx-auto p-4">
      <div class="mb-6">
        <p class="text-gray-400 text-sm">Made by l3v2s on discord</p>
      </div>

      <!-- Controls and Filters -->
      <div class="flex flex-col md:flex-row md:items-center justify-between mb-8 space-y-4 md:space-y-0">
        <div class="flex items-center">
          <span class="bg-red-600 text-white px-2 py-1 rounded mr-2">
            NEW
          </span>
          <h2 class="text-xl font-bold">Latest Chapters</h2>
        </div>
        <div class="flex flex-col sm:flex-row space-y-3 sm:space-y-0 sm:space-x-4">
          <div class="relative">
            <i class="fas fa-search absolute left-3 top-3 text-gray-400"></i>
            <input type="text" id="searchInput" placeholder="Search manga..." 
                  class="bg-gray-800 border border-gray-700 text-white pl-10 pr-4 py-2 rounded text-sm w-full">
          </div>
          <select id="seriesFilter" class="bg-gray-800 border border-gray-700 text-white px-4 py-2 rounded text-sm">
            <option value="all">All Series</option>
          </select>
          <button id="refreshButton" class="bg-gray-800 border border-gray-700 hover:bg-gray-700 text-white px-4 py-2 rounded flex items-center justify-center">
            <i class="fas fa-sync-alt mr-2"></i>
            <span>Refresh</span>
          </button>
        </div>
      </div>

      <!-- Manga Grid -->
      <div id="mangaGrid" class="grid grid-cols-1 sm:grid-cols-2 md:grid-cols-3 lg:grid-cols-4 xl:grid-cols-5 gap-5">
        <!-- Manga cards will be populated here by JavaScript -->
      </div>
    </div>

    <!-- Footer -->
    <footer class="bg-black py-6 mt-12">
      <div class="container mx-auto px-4">
        <div class="flex flex-col md:flex-row justify-between items-center">
          <div class="mb-4 md:mb-0">
            <p class="text-gray-400 text-sm">Â© 2025 Asura Premium</p>
          </div>
          <div class="flex space-x-4">
            <a href="#" class="text-gray-400 hover:text-red-500 transition duration-300">
              <i class="fab fa-discord text-lg"></i>
            </a>
            <a href="#" class="text-gray-400 hover:text-red-500 transition duration-300">
              <i class="fab fa-twitter text-lg"></i>
            </a>
            <a href="#" class="text-gray-400 hover:text-red-500 transition duration-300">
              <i class="fab fa-github text-lg"></i>
            </a>
          </div>
        </div>
      </div>
    </footer>
  </div>

<script>
  // Check login status on page load
  document.addEventListener('DOMContentLoaded', function() {
    checkLoginStatus();
  });

  // Login handling
  function checkLoginStatus() {
    const loginData = localStorage.getItem('loginData');
    
    if (loginData) {
      const parsedData = JSON.parse(loginData);
      const currentTime = new Date().getTime();
      
      // Check if the login is still valid (within 12 hours)
      if (parsedData.expiryTime > currentTime) {
        // Valid login
        showMainContent(parsedData);
        return;
      } else {
        // Login expired, clear localStorage
        localStorage.removeItem('loginData');
      }
    }
    
    // Not logged in or expired
    document.getElementById('login-screen').classList.remove('hidden');
    document.getElementById('content').classList.add('hidden');
  }

  document.getElementById('login-button').addEventListener('click', function() {
    const username = document.getElementById('username').value;
    const password = document.getElementById('password').value;
    
    if (!username || !password) {
      alert('Please enter both username and password');
      return;
    }
    
    // Here you would validate with your Discord bot's API
    // For demo purposes, let's assume validation is successful
    const isValidCredentials = true; // Replace with actual validation
    
    if (isValidCredentials) {
      // Set login data with 12-hour expiry
      const expiryTime = new Date().getTime() + (12 * 60 * 60 * 1000); // 12 hours from now
      
      const loginData = {
        username,
        expiryTime
      };
      
      localStorage.setItem('loginData', JSON.stringify(loginData));
      showMainContent(loginData);
    } else {
      alert('Invalid credentials. Please get valid login information from the Discord bot.');
    }
  });

  document.getElementById('logout-button').addEventListener('click', function() {
    localStorage.removeItem('loginData');
    document.getElementById('login-screen').classList.remove('hidden');
    document.getElementById('content').classList.add('hidden');
  });

  function showMainContent(loginData) {
    document.getElementById('login-screen').classList.add('hidden');
    document.getElementById('content').classList.remove('hidden');
    
    // Update session info
    const expiryTime = new Date(loginData.expiryTime);
    const sessionInfoEl = document.getElementById('session-info');
    sessionInfoEl.textContent = `${loginData.username} - Session expires: ${expiryTime.toLocaleTimeString()}`;
    
    // Load manga list
    loadMangaList();
  }

  // Function to load the state.json file and display manga
  async function loadMangaList() {
    try {
      const response = await fetch("state.json");
      if (!response.ok) {
        throw new Error('Failed to load data (status: ' + response.status + ')');
      }
      
      const data = await response.json();
      const downloadedChapters = data.downloadedChapters || {};
      
      // Process the data
      const seriesMap = {};
      
      // Group chapters by series
      Object.entries(downloadedChapters).forEach(([key, chapter]) => {
        // Skip invalid entries
        if (!chapter || typeof chapter !== 'object') {
          console.warn(`Skipping invalid chapter entry for key: ${key}`);
          return;
        }
        
        const [seriesName, chapterNumber] = key.split('_');
        
        // Check if chapter has a valid timestamp
        const timestamp = chapter.timestamp ? new Date(chapter.timestamp) : new Date();
        
        if (!seriesMap[seriesName]) {
          seriesMap[seriesName] = [];
        }
        
        // Check if path exists before using replace
        const path = chapter.path ? chapter.path.replace(/\\/g, '/') : '';
        
        seriesMap[seriesName].push({
          chapterNumber,
          timestamp,
          formattedTime: getTimeAgo(timestamp),
          path: path,
          imageCount: chapter.imageCount || 0
        });
      });
      
      // Sort chapters within each series by chapter number (newest first)
      Object.values(seriesMap).forEach(chapters => {
        chapters.sort((a, b) => {
          // Try to compare as numbers if possible
          const numA = parseFloat(a.chapterNumber);
          const numB = parseFloat(b.chapterNumber);
          
          if (!isNaN(numA) && !isNaN(numB)) {
            return numB - numA; // Descending order
          }
          
          // Fall back to string comparison
          return b.chapterNumber.localeCompare(a.chapterNumber);
        });
      });
      
      // Sort series by most recent chapter
      const sortedSeries = Object.entries(seriesMap).sort((a, b) => {
        const latestA = a[1][0].timestamp;
        const latestB = b[1][0].timestamp;
        return latestB - latestA;
      });
      
      // Store the full data for searching
      window.fullMangaData = sortedSeries;
      
      // Populate the filter dropdown
      const filterSelect = document.getElementById('seriesFilter');
      filterSelect.innerHTML = '<option value="all">All Series</option>';
      
      sortedSeries.forEach(([seriesName]) => {
        const formattedName = formatSeriesName(seriesName);
        const option = document.createElement('option');
        option.value = seriesName;
        option.textContent = formattedName;
        filterSelect.appendChild(option);
      });
      
      // Display the manga
      displayManga(sortedSeries);
      
      // Set up event listeners
      filterSelect.addEventListener('change', () => {
        const selectedSeries = filterSelect.value;
        if (selectedSeries === 'all') {
          displayManga(window.fullMangaData);
        } else {
          const filtered = window.fullMangaData.filter(([series]) => series === selectedSeries);
          displayManga(filtered);
        }
      });
      
      document.getElementById('refreshButton').addEventListener('click', () => {
        loadMangaList();
      });

      // Set up search functionality
      document.getElementById('searchInput').addEventListener('input', (e) => {
        const searchTerm = e.target.value.toLowerCase();
        if (!searchTerm) {
          displayManga(window.fullMangaData);
          return;
        }
        
        const filtered = window.fullMangaData.filter(([seriesName]) => 
          formatSeriesName(seriesName).toLowerCase().includes(searchTerm)
        );
        
        displayManga(filtered);
      });
      
    } catch (error) {
      console.error('Error loading list:', error);
      document.getElementById('mangaGrid').innerHTML = `
        <div class="col-span-full text-center p-8 bg-gray-800 border border-gray-700 rounded">
          <i class="fas fa-exclamation-triangle text-red-500 text-4xl mb-4"></i>
          <p class="text-xl">Failed to load manga data. Please check that state.json exists.</p>
          <p class="mt-2 text-gray-400">${error.message}</p>
          <button id="retryButton" class="mt-4 bg-red-600 hover:bg-red-700 text-white px-4 py-2 rounded">
            Retry Loading
          </button>   
        </div>
      `;

      // retry button 
      document.getElementById('retryButton').addEventListener('click', () => {
        loadMangaList();
      });
    }
  }

  // Function to display manga in the grid
  function displayManga(seriesList) {
    const mangaGrid = document.getElementById('mangaGrid');
    mangaGrid.innerHTML = '';
    
    if (seriesList.length === 0) {
      mangaGrid.innerHTML = `
        <div class="col-span-full text-center p-8 bg-gray-800 border border-gray-700 rounded">
          <i class="fas fa-search text-gray-500 text-4xl mb-4"></i>
          <p class="text-xl">No chapters found.</p>
        </div>
      `;
      return;
    }
    
    seriesList.forEach(([seriesName, chapters], index) => {
      const formattedName = formatSeriesName(seriesName);
      const card = document.createElement('div');
      card.className = 'bg-gray-800 border border-gray-700 rounded-lg overflow-hidden manga-card fade-in';
      card.style.animationDelay = `${index * 50}ms`;
      
      // Get the two most recent chapters
      const latestChapters = chapters.slice(0, 3);
      const latestChapter = latestChapters[0] || { chapterNumber: 'N/A' };
      
      // Calculate a random rating between 7.0 and 9.9
      const rating = (Math.floor(Math.random() * 30) + 70) / 10;
      
      // Create the HTML for the card
      card.innerHTML = `
        <div class="relative">
          <img alt="Cover image of ${formattedName}" class="w-full h-64 object-cover" 
               src="https://placehold.co/300x400/111/333?text=${encodeURIComponent(formattedName.substring(0, 10))}"/>
          <div class="absolute top-0 right-0 bg-red-600 text-white px-2 py-1 m-2 rounded text-xs">
            <i class="fas fa-fire"></i> HOT
          </div>
        </div>
        <div class="p-4">
          <div class="flex items-center justify-between mb-2">
            <span class="text-yellow-500 flex items-center">
              <i class="fas fa-star mr-1"></i>
              <span class="font-bold">${rating.toFixed(1)}</span>
            </span>
            <span class="text-green-500 text-sm flex items-center">
              <i class="fas fa-circle text-xs mr-1"></i>
              Ongoing
            </span>
          </div>
          <h2 class="text-lg font-bold mb-3 truncate" title="${formattedName}">
            ${formattedName}
          </h2>
        </div>
      `;
      
      // Create chapter container
      const chapterContainer = document.createElement('div');
      chapterContainer.className = 'px-4 pb-4';
      
      // Create chapter links
      latestChapters.forEach((chapter, index) => {
        const chapterPath = chapter.path || '';
        const htmlLink = chapterPath ? 
          `./${chapterPath}/${seriesName.toLowerCase().replace(/\s+/g, '_')}_chapter_${chapter.chapterNumber}.html` : 
          '#';
        
        const chapterDiv = document.createElement('div');
        chapterDiv.className = 'bg-gray-900 p-2 rounded mb-2 chapter-link hover:bg-gray-700 transition-all';
        
        chapterDiv.innerHTML = `
          <a href="${htmlLink}" class="flex items-center justify-between w-full">
            <span class="${index === 0 ? 'text-yellow-500' : 'text-white'}">
              <i class="fas ${index === 0 ? 'fa-bookmark' : 'fa-book'} mr-2"></i>
              Chapter ${chapter.chapterNumber}
            </span>
            <span class="${index === 0 ? 'text-red-500' : 'text-gray-400'} text-xs">
              ${index === 0 ? 'â¢ NEW' : 'â¢ ' + chapter.formattedTime}
            </span>
          </a>
        `;
        
        chapterContainer.appendChild(chapterDiv);
      });
      
      card.appendChild(chapterContainer);
      mangaGrid.appendChild(card);
    });
  }

  // Helper function to format series name (convert from snake_case to Title Case)
  function formatSeriesName(seriesName) {
    if (seriesName === 'Unknown Series') return seriesName;
    
    return seriesName
      .split('_')
      .map(word => word.charAt(0).toUpperCase() + word.slice(1))
      .join(' ');
  }
  
  // Helper function to format timestamps as "X time ago"
  function getTimeAgo(timestamp) {
    const now = new Date();
    const diff = now - timestamp;
    
    const minutes = Math.floor(diff / 60000);
    const hours = Math.floor(minutes / 60);
    const days = Math.floor(hours / 24);
    
    if (days > 0) {
      return `${days} day${days > 1 ? 's' : ''} ago`;
    } else if (hours > 0) {
      return `${hours} hour${hours > 1 ? 's' : ''} ago`;
    } else if (minutes > 0) {
      return `${minutes} minute${minutes > 1 ? 's' : ''} ago`;
    } else {
      return 'just now';
    }
  }
</script>
</body>
</html>
